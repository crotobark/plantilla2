<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reportes - Inventarios</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/reporte.css">

  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header class="header">
    <h1>📊 Sistema de Inventarios</h1>
    <button id="logoutBtn" class="logout">Cerrar sesión</button>
  </header>

  <div class="container">
    <aside class="sidebar">
      <h2>Menú</h2>
      <nav>
        <a href="dashboard.html">Inicio</a>
        <a href="entrada.html">Entradas</a>
        <a href="salida.html">Salidas</a>
        <a href="reporte.html" class="active">Reportes</a>
      </nav>
    </aside>

    <main class="content">
      <h2>📈 Reporte General de Inventario</h2>
      <p>Resumen consolidado de entradas, salidas y stock actual por producto.</p>

      <div class="resumen">
        <div class="card">
          <h3>🔼 Entradas</h3>
          <p id="totalEntradas">0</p>
        </div>
        <div class="card">
          <h3>🔽 Salidas</h3>
          <p id="totalSalidas">0</p>
        </div>
        <div class="card">
          <h3>⚖️ Stock Actual</h3>
          <p id="totalStock">0</p>
        </div>
      </div>

      <div class="botones">
        <button id="btnExcel" class="btn-excel">⬇️ Descargar Excel</button>
        <button id="btnPDF" class="btn-pdf">⬇️ Descargar PDF</button>
      </div>

      <h3>📋 Detalle de productos</h3>
      <table class="tabla" id="tablaReportes">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Total Entradas</th>
            <th>Total Salidas</th>
            <th>Stock Actual</th>
          </tr>
        </thead>
        <tbody>
          <!-- Se llena dinámicamente -->
        </tbody>
      </table>
    </main>
  </div>

  <script>
    // Protección de sesión
    if (!sessionStorage.getItem("loggedIn")) {
      window.location.href = "login.html";
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      sessionStorage.removeItem("loggedIn");
      window.location.href = "login.html";
    });

    const entradas = JSON.parse(localStorage.getItem('entradas') || '[]');
    const salidas = JSON.parse(localStorage.getItem('salidas') || '[]');

    const resumen = {};
    let totalEntradas = 0;
    let totalSalidas = 0;

    entradas.forEach(e => {
      totalEntradas += e.cantidad;
      if (!resumen[e.producto]) resumen[e.producto] = { entradas: 0, salidas: 0 };
      resumen[e.producto].entradas += e.cantidad;
    });

    salidas.forEach(s => {
      totalSalidas += s.cantidad;
      if (!resumen[s.producto]) resumen[s.producto] = { entradas: 0, salidas: 0 };
      resumen[s.producto].salidas += s.cantidad;
    });

    let totalStock = 0;
    const tbody = document.querySelector("#tablaReportes tbody");

    if (Object.keys(resumen).length > 0) {
      tbody.innerHTML = Object.entries(resumen)
        .map(([producto, datos]) => {
          const stock = datos.entradas - datos.salidas;
          totalStock += stock;
          return `
            <tr>
              <td>${producto}</td>
              <td>${datos.entradas}</td>
              <td>${datos.salidas}</td>
              <td>${stock >= 0 ? stock : 0}</td>
            </tr>
          `;
        })
        .join('');
    } else {
      tbody.innerHTML = `<tr><td colspan="4" class="empty">No hay datos para mostrar.</td></tr>`;
    }

    document.getElementById("totalEntradas").textContent = totalEntradas;
    document.getElementById("totalSalidas").textContent = totalSalidas;
    document.getElementById("totalStock").textContent = totalStock;

    // =============================
    // EXPORTAR A EXCEL
    // =============================
    document.getElementById("btnExcel").addEventListener("click", () => {
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Producto,Entradas,Salidas,Stock\n";

      Object.entries(resumen).forEach(([producto, datos]) => {
        const stock = datos.entradas - datos.salidas;
        csvContent += `${producto},${datos.entradas},${datos.salidas},${stock}\n`;
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "reporte_inventario.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // =============================
    // EXPORTAR A PDF
    // =============================
    document.getElementById("btnPDF").addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Reporte General de Inventario", 14, 15);
      doc.setFontSize(11);
      doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 14, 25);

      let y = 35;
      doc.text("Producto        Entradas    Salidas    Stock", 14, y);
      y += 5;

      Object.entries(resumen).forEach(([producto, datos]) => {
        const stock = datos.entradas - datos.salidas;
        doc.text(
          `${producto.padEnd(15)} ${String(datos.entradas).padEnd(10)} ${String(datos.salidas).padEnd(10)} ${stock}`,
          14,
          y
        );
        y += 6;
      });

      doc.text(`\nTotal Entradas: ${totalEntradas}`, 14, y + 10);
      doc.text(`Total Salidas: ${totalSalidas}`, 14, y + 16);
      doc.text(`Stock Actual: ${totalStock}`, 14, y + 22);

      doc.save("reporte_inventario.pdf");
    });
  </script>
</body>
</html>
    <footer class="main-footer">
        <p>© 2025 Mi sitio web. Todos los derechos reservados.</p>
    </footer>